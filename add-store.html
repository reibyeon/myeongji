<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>명지국제자유방 이웃점빵 - 신규점빵 등록</title>

    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

    <!-- AG Grid CSS -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-grid.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/ag-grid-community/styles/ag-theme-alpine.css">

    <style>
        body {
            background-color: #FFF6E3;
            color: #333;
            font-family: 'Noto Sans KR', sans-serif;
        }

        .logo-container {
            text-align: center;
            padding: 20px 0;
            background: linear-gradient(to right, #FFF6E3, #FFFFFF);
            margin-bottom: 1px;
            border-bottom: 1px solid rgba(0,0,0,0.05);
        }

        .logo-container img {
            max-width: 200px;
            max-height: 180px;
        }

        .form-container {
            background-color: white;
            border-radius: 15px;
            padding: 30px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.05);
            margin-bottom: 40px;
        }

        .form-label {
            font-weight: 500;
            color: #4A90E2;
        }

        .form-control:focus, .form-select:focus {
            border-color: #BFECFF;
            box-shadow: 0 0 0 0.2rem rgba(191, 236, 255, 0.25);
        }

        .btn-primary {
            background-color: #BFECFF;
            border-color: #95D8FF;
            color: #333;
            font-weight: 500;
        }

        .btn-primary:hover {
            background-color: #95D8FF;
            border-color: #7CC4FF;
            color: #333;
        }

        .page-title {
            color: #4A90E2;
            font-weight: 600;
            margin-bottom: 30px;
        }

        footer {
            border-top: 1px solid #FFE0B2;
            background-color: #FFF6E3;
            padding: 15px 0;
        }

        .required-field::after {
            content: " *";
            color: #d9534f;
        }

        #userInfoBar {
            background-color: #FFF6E3;
            border-bottom: 1px solid #FFE0B2;
            padding: 10px 20px;
        }

        #loggedInUser {
            font-weight: 500;
            color: #4A90E2;
        }
    </style>
</head>
<body>
    <a href="index.html" style="text-decoration: none;">
        <div class="logo-container">
            <img src="images/logo.png" alt="명지국제자유방 이웃점빵 로고">
        </div>
    </a>

    <!-- 상단 사용자 정보 바 -->
    <div id="userInfoBar" class="d-flex justify-content-end align-items-center">
        <span id="loggedInUser" class="me-3"></span>
        <button id="logoutButton" class="btn btn-sm btn-outline-secondary">로그아웃</button>
    </div>

    <!-- 점빵 목록 (AG Grid) 추가 -->
    <div class="container mb-4">
        <h4 class="page-title">이웃점빵</h4>
        <div id="storeGrid" class="ag-theme-alpine" style="height: 300px; width: 100%;"></div>
    </div>

    <div class="container py-4">
        <div class="row justify-content-center">
            <div class="col-lg-8">
                <h2 class="page-title text-center">신규점빵 등록</h2>

                <div class="form-container">
                    <form id="storeForm">
                        <!-- Form Fields (카테고리, 점빵명 등 동일 생략) -->
                        <div class="mb-3">
                            <label for="category" class="form-label required-field">카테고리</label>
                            <select class="form-select" id="category" name="category" required>
                                <option value="" selected disabled>카테고리 선택</option>
                                <option value="음식/카페">음식/카페</option>
                                <option value="생활/편의">생활/편의</option>
                                <option value="건강/뷰티">건강/뷰티</option>
                                <option value="기타">기타</option>
                            </select>
                        </div>
                        <div class="mb-3">
                            <label for="name" class="form-label required-field">점빵명</label>
                            <input type="text" class="form-control" id="name" name="name" required>
                        </div>
                        <div class="mb-3">
                            <label for="nickname" class="form-label required-field">점주닉네임</label>
                            <input type="text" class="form-control" id="nickname" name="nickname" required>
                        </div>
                        <div class="mb-3">
                            <label for="description" class="form-label">점빵 설명</label>
                            <textarea class="form-control" id="description" name="description" rows="3"></textarea>
                        </div>
                        <div class="mb-3">
                            <label for="benefit" class="form-label">점빵 제공 혜택</label>
                            <input type="text" class="form-control" id="benefit" name="benefit">
                        </div>
                        <div class="mb-3">
                            <label for="code" class="form-label">점빵 암호</label>
                            <input type="text" class="form-control" id="code" name="code">
                        </div>
                        <div class="mb-3">
                            <label for="contact" class="form-label">연락처</label>
                            <input type="text" class="form-control" id="contact" name="contact">
                        </div>
                        <div class="mb-3">
                            <label for="address" class="form-label">주소</label>
                            <input type="text" class="form-control" id="address" name="address">
                        </div>
                        <div class="mb-3">
                            <label for="site" class="form-label">웹사이트</label>
                            <input type="url" class="form-control" id="site" name="site">
                        </div>

                        <div class="d-grid gap-2 d-md-flex justify-content-md-end mt-4">
                            <a href="index.html" class="btn btn-outline-secondary me-md-2">취소</a>
                            <button type="submit" class="btn btn-primary">등록하기</button>
                        </div>
                    </form>
                </div>

                <!-- 알림 -->
                <div class="alert alert-success alert-dismissible fade show d-none" id="successAlert">
                    <strong>등록 성공!</strong> 새로운 점빵이 등록되었습니다.
                    <a href="index.html" class="alert-link">메인 페이지로 돌아가기</a>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
                <div class="alert alert-danger alert-dismissible fade show d-none" id="errorAlert">
                    <strong>등록 실패!</strong> <span id="errorMessage">오류가 발생했습니다.</span>
                    <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
                </div>
            </div>
        </div>
    </div>

    <footer class="bg-white py-3 mt-4">
        <div class="container text-center">
            <small class="text-muted">© 2025 삼정더베스트/록커. All Rights Reserved.</small>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/ag-grid-community/dist/ag-grid-community.min.noStyle.js"></script>

    <script>
        let token = localStorage.getItem('auth_token'); // token 전역 선언
        let isEditMode = false;
        let selectedStoreId = null;

        // ag-Grid 초기화
        const gridOptions = {
            columnDefs: [
                { headerName: '카테고리', field: 'category', sortable: true },
                { headerName: '점빵명', field: 'name', sortable: true },
                { headerName: '점주닉네임', field: 'nickname', sortable: true },
                { headerName: '연락처', field: 'contact' }
            ],
            defaultColDef: {
                resizable: true,
                flex: 1
            },
            rowSelection: 'single',
            onRowClicked: onStoreSelected
        };

        const gridDiv = document.getElementById('storeGrid');
        new agGrid.Grid(gridDiv, gridOptions);

        async function loadStores() {
            try {
                const response = await fetch('https://gw.ecron.co.kr:81/api/stores', {
                    method: 'GET',
                    headers: {
                        'Authorization': `Bearer ${token}`
                    }
                });
                const data = await response.json();
                if (response.ok) {
                    gridOptions.api.setRowData(data.stores);
                } else {
                    throw new Error('점빵 목록 불러오기 실패');
                }
            } catch (e) {
                console.error('AG Grid 데이터 로드 실패:', e);
            }
        }

        function onStoreSelected(event) {
            const store = event.data;
            selectedStoreId = store.id; // 수정 시 필요
            isEditMode = true;

            // 폼에 값 채우기
            document.getElementById('category').value = store.category;
            document.getElementById('name').value = store.name;
            document.getElementById('nickname').value = store.nickname;
            document.getElementById('description').value = store.description;
            document.getElementById('benefit').value = store.benefit;
            document.getElementById('code').value = store.code;
            document.getElementById('contact').value = store.contact;
            document.getElementById('address').value = store.address;
            document.getElementById('site').value = store.site;
        }

        document.addEventListener('DOMContentLoaded', async function () {
            const loggedInUser = localStorage.getItem('username');
            if (loggedInUser) {
                document.getElementById('loggedInUser').textContent = `${loggedInUser}님`;
            }
            loadStores();
        });

        // 로그아웃 처리
        document.getElementById('logoutButton').addEventListener('click', function() {
            localStorage.clear();
            location.href = 'login.html'; // 로그아웃 후 로그인 페이지로 리디렉션
        });

        // 폼 제출 시
        document.getElementById('storeForm').addEventListener('submit', async function(event) {
            event.preventDefault();

            const formData = new FormData(event.target);

            const storeData = {
                category: formData.get('category'),
                name: formData.get('name'),
                nickname: formData.get('nickname'),
                description: formData.get('description'),
                benefit: formData.get('benefit'),
                code: formData.get('code'),
                contact: formData.get('contact'),
                address: formData.get('address'),
                site: formData.get('site')
            };

            try {
                const method = isEditMode ? 'PUT' : 'POST';
                const url = isEditMode ? `https://gw.ecron.co.kr:81/api/stores/${selectedStoreId}` : 'https://gw.ecron.co.kr:81/api/stores';
                
                const response = await fetch(url, {
                    method: method,
                    headers: {
                        'Authorization': `Bearer ${token}`,
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(storeData)
                });

                const data = await response.json();
                if (response.ok) {
                    document.getElementById('successAlert').classList.remove('d-none');
                    loadStores(); // 등록 후 목록 갱신
                } else {
                    document.getElementById('errorMessage').textContent = data.message || '오류 발생';
                    document.getElementById('errorAlert').classList.remove('d-none');
                }
            } catch (e) {
                console.error('점빵 등록 중 오류 발생:', e);
                document.getElementById('errorAlert').classList.remove('d-none');
            }
        });
    </script>
</body>
</html>
